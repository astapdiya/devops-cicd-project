pipeline {
  agent any
  environment {
    ECR_REPO = "225989348084.dkr.ecr.us-east-1.amazonaws.com/super-service"
    IMAGE_TAG = "latest"
  }

  stages {
    stage('Checkout') {
      steps { git credentialsId:'github-jenkins-cred' url: 'https://github.com/astapdiya/devops-cicd-project.git' }
    }

    stage('Docker Build & Push') {
      steps {
        sh 'aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_REPO'
        sh 'docker build -t $ECR_REPO:$IMAGE_TAG .'
        sh 'docker push $ECR_REPO:$IMAGE_TAG'
      }
    }

    stage('Terraform Apply') {
      steps {
        dir('terraform') {
          sh 'terraform init'
          sh 'terraform apply -auto-approve'
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh 'kubectl apply -f k8s/'
      }
    }

    stage('Run Ansible') {
      steps {
        sh 'ansible-playbook ansible/playbook.yml -i "localhost," --connection=local'
      }
    }
  }
}
